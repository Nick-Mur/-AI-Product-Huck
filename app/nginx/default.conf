map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# Redirect all HTTP to HTTPS
server {
    listen 80;
    server_name jgsnapp.ru www.jgsnapp.ru _;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    http2 on;
    server_name jgsnapp.ru www.jgsnapp.ru _;

    ssl_certificate     /etc/nginx/certs/fullchain.pem;
    ssl_certificate_key /etc/nginx/certs/certificate.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    # Increase limit for file uploads
    client_max_body_size 100m;

    # API: Static images served by FastAPI
    location ^~ /images/ {
        proxy_pass http://server:5000;
        proxy_read_timeout 600s;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # Avoid disk buffering for large images
        proxy_buffering off;
    }

    # API: exact endpoints
    location ~ ^/(upload|audio|transcript)$ {
        proxy_pass http://server:5000;
        proxy_read_timeout 600s;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # API: grouped prefixes
    location ~ ^/(review|slides)/ {
        proxy_pass http://server:5000;
        proxy_read_timeout 600s;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Frontend (CRA dev server behind proxy)
    location / {
        # CRA is started with HTTPS in the frontend Dockerfile
        proxy_pass https://frontend:3000;
        proxy_http_version 1.1;
        # Force a safe Host header for CRA/WDS to avoid "Invalid Host header"
        # Using localhost makes webpack-dev-server accept requests from any external domain
        proxy_set_header Host localhost;
        # Upstream uses a self-signed cert; don't verify and set SNI name
        proxy_ssl_verify off;
        proxy_ssl_server_name on;
        proxy_ssl_name localhost;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }
}
